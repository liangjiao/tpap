/*! caja-kissy  */
KISSY.add("init-countdown-widgets",function(n){function t(t,e){var r=this;cfg={timeBegin:0,collateurl:"",collateval:0},r.timeStart=new Date,r.config=n.merge(cfg,e||{}),r._countTime(t)}function e(t,r,o){var i={d:".ks-d",h:".ks-h",m:".ks-m",s:".ks-s",i:".ks-i"},a={interval:1e3,timeUnitCls:i,minDigit:2,timeRunCls:".ks-countdown-run",timeEndCls:".ks-countdown-end"},s=n.merge(a,o);s.run&&!n.isFunction(s.run)&&delete s.run,s.end&&!n.isFunction(s.end)&&delete s.end,s.interval=parseInt(s.interval),(isNaN(s.interval)||200>s.interval)&&(s.interval=200),e.superclass.constructor.call(this,r,s),this.counter(t)}function r(t,e){var r=function(t){n.isDate(t)||(t=new Date),n.isFunction(e)&&e(t)};n.io({url:t,type:"HEAD",success:function(n,t,e){r(new Date(e.getResponseHeader("date")))},error:function(){r(new Date)},cache:!1})}function r(t,e){function r(n,t){1e3>n?e(t):3>i?o():e(new Date(t.setMilliseconds(t.getMilliseconds()+n/2)))}function o(){var e=new Date;i++,n.io({url:t,type:"HEAD",success:function(n,t,o){r(new Date-e,new Date(o.getResponseHeader("date")))},error:function(){r()},cache:!1})}var i=0;o()}function o(t,e,o){t="."+(t||"J_TWidget");var a=function(r){n.query(t,e).each(function(t){var e=i.attr(t,"data-widget-type"),o=i.attr(t,"data-widget-config");"Countdown"===e&&(o=n.isNull(o)?{}:JSON.parse(o.replace(/'/g,'"')),r&&n.isDate(r)&&(o.timeBegin=r),new n.Countdown(t,o.endTime,o))})};o?r(o,a):a()}var i=n.DOM,a={d:864e5,h:36e5,m:6e4,s:1e3,i:1},s=["d","h","m","s","i"];return t.prototype={_countTime:function(t){var e=this,r=e.config,o=r.timeBegin,i=0;if(/^(\d{4})\-(\d{1,2})\-(\d{1,2})(\s+)(\d{1,2}):(\d{1,2}):(\d{1,2})$/gi.test(t.replace(/\./g,"-"))){var a=t.match(/\d+/g);t=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])}else/^\d+&/.test(t)&&(t=parseInt(t));i=n.isNull(o)||isNaN(o)||0>=o?n.isDate(t)?t-new Date:parseInt(t):typeof o==typeof t?t-o:0,(!n.isNumber(i)||0>i)&&(i=0),e.timeRemain=i},getRemain:function(){var n=parseInt(this.timeRemain-(new Date-this.timeStart));return isNaN(n)||0>=n?0:n},format:function(t){var e=Array.prototype.slice.call(arguments,1),r=[];return n.each(e,function(n){if(a[n]){var e=Math.floor(t/a[n]);t-=e*a[n],r.push(e)}}),r},fetch:function(n,t,e){var r=this,o=setInterval(function(){var n=r.getRemain();n>0?t&&t.call(r,n):(t&&t.call(r,0),e&&e.call(r),clearInterval(o))},n)}},n.extend(e,t,{counter:function(t){var e=this,r=e.config,o=function(t){var o=[t].concat(d),i=e.format.apply(this,o);n.each(l,function(n,t){n.text(i[t])}),r.run&&r.run.call(e,o,i)},i=function(){u.hide(),c.show(),r.end&&r.end.call(e)},a=r.timeUnitCls,t=n.one(t),u=t.all(r.timeRunCls),c=t.all(r.timeEndCls),l=[],d=[];n.each(s,function(n){a[n]&&t.one(a[n])&&(l.push(t.one(a[n])),d.push(n))}),u.show(),c.hide(),e.fetch(r.interval,o,i)}}),e.autoRender=o,e.Core=t,e.getServerTime=r,n.Countdown=e,e}),KISSY.use("switchable, init-countdown-widgets",function(n,t,e){function r(r,o){function i(){n.later(function(){if(0!==u.length){try{a(u.shift())}catch(t){n.log("\u521d\u59cb\u5316\u7ec4\u4ef6\u51fa\u9519")}i()}},0)}function a(r){var o,i=r.getAttribute("data-widget-type");if(i)try{switch(o=r.getAttribute("data-widget-config"),o&&(o=o.replace(/'/g,'"')),o=n.JSON.parse(o),!0){case s.switchable.indexOf(i)>-1:new t(r,o);break;case s.countdown.indexOf(i)>-1:new e(r,o.endTime,o);break;default:n.log("\u5728kissy\u5e93\u4e2d\u6ca1\u6709\u67e5\u627e\u5230\u4f60\u60f3\u8981\u521d\u59cb\u5316\u7684\u7ec4\u4ef6")}}catch(a){n.log("widget "+a,"warn")}}r="."+(r||"KS_Widget");var s={switchable:"Tabs Slide Carousel Accordion",overlay:"Popup",countdown:"Countdown"},u=n.query(r,o);i()}var o=n.DOM,i="J_TScriptedModule";KISSY.each(o.query("."+i),function(n){r("J_TWidget",n)})});